<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Sales Offer Report Template -->
    <template id="sales_offer_report_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="web.external_layout">
                    <div class="page">
                        <style>
                            .sales-offer-header {
                                text-align: center;
                                margin-bottom: 30px;
                                border-bottom: 3px solid #2c3e50;
                                padding-bottom: 20px;
                            }
                            .sales-offer-title {
                                font-size: 32px;
                                font-weight: bold;
                                color: #2c3e50;
                                margin-bottom: 10px;
                            }
                            .sales-offer-subtitle {
                                font-size: 16px;
                                color: #7f8c8d;
                            }
                            .section-header {
                                background-color: #3498db;
                                color: white;
                                padding: 10px 15px;
                                margin-top: 25px;
                                margin-bottom: 15px;
                                font-size: 18px;
                                font-weight: bold;
                                border-radius: 5px;
                            }
                            .info-row {
                                margin-bottom: 12px;
                                padding: 8px 0;
                                border-bottom: 1px solid #ecf0f1;
                            }
                            .info-label {
                                font-weight: bold;
                                color: #2c3e50;
                                display: inline-block;
                                width: 200px;
                            }
                            .info-value {
                                color: #34495e;
                            }
                            .property-image-container {
                                text-align: center;
                                margin: 20px 0;
                                page-break-inside: avoid;
                            }
                            .property-image {
                                max-width: 100%;
                                max-height: 400px;
                                border: 2px solid #bdc3c7;
                                border-radius: 8px;
                                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            }
                            .image-caption {
                                font-style: italic;
                                color: #7f8c8d;
                                margin-top: 10px;
                                font-size: 14px;
                            }
                            .payment-table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 15px;
                            }
                            .payment-table th {
                                background-color: #34495e;
                                color: white;
                                padding: 12px;
                                text-align: left;
                                font-weight: bold;
                            }
                            .payment-table td {
                                padding: 10px 12px;
                                border-bottom: 1px solid #ecf0f1;
                            }
                            .payment-table tr:nth-child(even) {
                                background-color: #f8f9fa;
                            }
                            .payment-table tr:hover {
                                background-color: #e8f4f8;
                            }
                            .summary-box {
                                background-color: #ecf0f1;
                                padding: 20px;
                                border-radius: 8px;
                                margin: 20px 0;
                            }
                            .summary-item {
                                display: flex;
                                justify-content: space-between;
                                padding: 8px 0;
                                border-bottom: 1px solid #bdc3c7;
                            }
                            .summary-item:last-child {
                                border-bottom: none;
                                font-weight: bold;
                                font-size: 18px;
                                color: #2c3e50;
                                margin-top: 10px;
                                padding-top: 15px;
                                border-top: 2px solid #2c3e50;
                            }
                            .status-badge {
                                display: inline-block;
                                padding: 5px 15px;
                                border-radius: 15px;
                                font-weight: bold;
                                font-size: 14px;
                            }
                            .status-available {
                                background-color: #27ae60;
                                color: white;
                            }
                            .status-reserved {
                                background-color: #f39c12;
                                color: white;
                            }
                            .status-booked {
                                background-color: #3498db;
                                color: white;
                            }
                            .status-sold {
                                background-color: #95a5a6;
                                color: white;
                            }
                            .footer-note {
                                margin-top: 40px;
                                padding: 20px;
                                background-color: #fff8dc;
                                border-left: 4px solid #f39c12;
                                font-size: 13px;
                                color: #7f8c8d;
                            }
                            .installment-unpaid {
                                color: #e74c3c;
                                font-weight: bold;
                            }
                            .installment-paid {
                                color: #27ae60;
                                font-weight: bold;
                            }
                        </style>

                        <!-- Header Section -->
                        <div class="sales-offer-header">
                            <div class="sales-offer-title">SALES OFFER</div>
                            <div class="sales-offer-subtitle">Property Sale Proposal</div>
                        </div>

                        <!-- Sale Reference Information -->
                        <div class="info-row">
                            <span class="info-label">Sale Reference:</span>
                            <span class="info-value" t-field="o.name"/>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Sale Date:</span>
                            <span class="info-value" t-field="o.sale_date"/>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Start Date:</span>
                            <span class="info-value" t-field="o.start_date"/>
                        </div>

                        <!-- Customer Information Section -->
                        <div class="section-header">Customer Information</div>
                        <div class="info-row">
                            <span class="info-label">Customer Name:</span>
                            <span class="info-value" t-field="o.partner_id.name"/>
                        </div>
                        <div class="info-row" t-if="o.partner_id.email">
                            <span class="info-label">Email:</span>
                            <span class="info-value" t-field="o.partner_id.email"/>
                        </div>
                        <div class="info-row" t-if="o.partner_id.phone">
                            <span class="info-label">Phone:</span>
                            <span class="info-value" t-field="o.partner_id.phone"/>
                        </div>
                        <div class="info-row" t-if="o.partner_id.mobile">
                            <span class="info-label">Mobile:</span>
                            <span class="info-value" t-field="o.partner_id.mobile"/>
                        </div>
                        <div class="info-row" t-if="o.partner_id.street or o.partner_id.city or o.partner_id.country_id">
                            <span class="info-label">Address:</span>
                            <span class="info-value">
                                <t t-if="o.partner_id.street"><span t-field="o.partner_id.street"/><br/></t>
                                <t t-if="o.partner_id.street2"><span t-field="o.partner_id.street2"/><br/></t>
                                <t t-if="o.partner_id.city"><span t-field="o.partner_id.city"/>, </t>
                                <t t-if="o.partner_id.state_id"><span t-field="o.partner_id.state_id.name"/> </t>
                                <t t-if="o.partner_id.zip"><span t-field="o.partner_id.zip"/><br/></t>
                                <t t-if="o.partner_id.country_id"><span t-field="o.partner_id.country_id.name"/></t>
                            </span>
                        </div>

                        <!-- Property Details Section -->
                        <div class="section-header">Property Details</div>

                        <div class="info-row">
                            <span class="info-label">Property Name:</span>
                            <span class="info-value" t-field="o.property_id.name"/>
                        </div>
                        <div class="info-row" t-if="o.property_id.property_reference">
                            <span class="info-label">Property Reference:</span>
                            <span class="info-value" t-field="o.property_id.property_reference"/>
                        </div>
                        <div class="info-row" t-if="o.property_id.project_name">
                            <span class="info-label">Project Name:</span>
                            <span class="info-value" t-field="o.property_id.project_name"/>
                        </div>
                        <div class="info-row" t-if="o.property_id.property_type">
                            <span class="info-label">Property Type:</span>
                            <span class="info-value" t-field="o.property_id.property_type"/>
                        </div>
                        <div class="info-row" t-if="o.property_id.tower">
                            <span class="info-label">Tower:</span>
                            <span class="info-value" t-field="o.property_id.tower"/>
                        </div>
                        <div class="info-row" t-if="o.property_id.level">
                            <span class="info-label">Level:</span>
                            <span class="info-value" t-field="o.property_id.level"/>
                        </div>
                        <div class="info-row" t-if="o.property_id.unit_no">
                            <span class="info-label">Unit No:</span>
                            <span class="info-value" t-field="o.property_id.unit_no"/>
                        </div>
                        <div class="info-row" t-if="o.property_id.unit_view">
                            <span class="info-label">Unit View:</span>
                            <span class="info-value" t-field="o.property_id.unit_view"/>
                        </div>
                        <div class="info-row" t-if="o.property_id.total_sqft">
                            <span class="info-label">Total Sqft:</span>
                            <span class="info-value"><t t-esc="'{:,.2f}'.format(o.property_id.total_sqft)"/> sqft</span>
                        </div>
                        <div class="info-row" t-if="o.property_id.price_per_sqft">
                            <span class="info-label">Price per Sqft:</span>
                            <span class="info-value">
                                <t t-esc="o.currency_id.symbol"/>
                                <t t-esc="'{:,.2f}'.format(o.property_id.price_per_sqft)"/>
                            </span>
                        </div>
                        <div class="info-row" t-if="o.property_id.address">
                            <span class="info-label">Property Address:</span>
                            <span class="info-value" t-field="o.property_id.address"/>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Property Status:</span>
                            <span class="info-value">
                                <span t-if="o.property_id.state == 'available'" class="status-badge status-available">Available</span>
                                <span t-if="o.property_id.state == 'reserved'" class="status-badge status-reserved">Reserved</span>
                                <span t-if="o.property_id.state == 'booked'" class="status-badge status-booked">Booked</span>
                                <span t-if="o.property_id.state == 'sold'" class="status-badge status-sold">Sold</span>
                            </span>
                        </div>
                        <div class="info-row" t-if="o.property_id.sale_rent">
                            <span class="info-label">Listing Type:</span>
                            <span class="info-value">
                                <t t-if="o.property_id.sale_rent == 'for_sale'">For Sale</t>
                                <t t-if="o.property_id.sale_rent == 'for_rent'">For Rent</t>
                            </span>
                        </div>
                        <div class="info-row" t-if="o.property_id.description">
                            <span class="info-label">Description:</span>
                            <span class="info-value" t-field="o.property_id.description"/>
                        </div>

                        <!-- Property Images Section -->
                        <t t-if="o.property_id.property_image">
                            <div class="section-header">Property Image</div>
                            <div class="property-image-container">
                                <img class="property-image" t-att-src="'data:image/png;base64,%s' % o.property_id.property_image.decode()" alt="Property Image"/>
                                <div class="image-caption">Property Image - <t t-esc="o.property_id.name"/></div>
                            </div>
                        </t>

                        <t t-if="o.property_id.floor_plan">
                            <div class="section-header">Floor Plan</div>
                            <div class="property-image-container">
                                <img class="property-image" t-att-src="'data:image/png;base64,%s' % o.property_id.floor_plan.decode()" alt="Floor Plan"/>
                                <div class="image-caption">Floor Plan - <t t-esc="o.property_id.name"/></div>
                            </div>
                        </t>                        <!-- Financial Summary Section -->
                        <div class="section-header">Financial Summary</div>
                        <div class="summary-box">
                            <div class="summary-item">
                                <span>Property Value:</span>
                                <span><t t-esc="o.currency_id.symbol"/><t t-esc="'{:,.2f}'.format(o.property_value)"/></span>
                            </div>
                            <div class="summary-item">
                                <span>DLD Fee (4%):</span>
                                <span><t t-esc="o.currency_id.symbol"/><t t-esc="'{:,.2f}'.format(o.dld_fee)"/></span>
                            </div>
                            <div class="summary-item">
                                <span>Admin Fee:</span>
                                <span><t t-esc="o.currency_id.symbol"/><t t-esc="'{:,.2f}'.format(o.admin_fee)"/></span>
                            </div>
                            <div class="summary-item">
                                <span>Total Selling Price:</span>
                                <span><t t-esc="o.currency_id.symbol"/><t t-esc="'{:,.2f}'.format(o.total_selling_price)"/></span>
                            </div>
                            <div class="summary-item">
                                <span>Down Payment (<t t-esc="'{:.1f}'.format(o.down_payment_percentage)"/>%):</span>
                                <span><t t-esc="o.currency_id.symbol"/><t t-esc="'{:,.2f}'.format(o.down_payment)"/></span>
                            </div>
                            <div class="summary-item">
                                <span>Remaining Balance:</span>
                                <span><t t-esc="o.currency_id.symbol"/><t t-esc="'{:,.2f}'.format(o.remaining_balance)"/></span>
                            </div>
                            <div class="summary-item">
                                <span>Number of Installments:</span>
                                <span><t t-esc="o.no_of_installments"/></span>
                            </div>
                            <div class="summary-item">
                                <span>Amount per Installment:</span>
                                <span><t t-esc="o.currency_id.symbol"/><t t-esc="'{:,.2f}'.format(o.amount_per_installment)"/></span>
                            </div>
                        </div>

                        <!-- Payment Schedule Section -->
                        <div class="section-header">Payment Schedule</div>
                        <table class="payment-table">
                            <thead>
                                <tr>
                                    <th style="width: 10%;">No.</th>
                                    <th style="width: 25%;">Payment Type</th>
                                    <th style="width: 20%;">Due Date</th>
                                    <th style="width: 25%;">Amount</th>
                                    <th style="width: 20%;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="o.property_sale_line_ids.sorted(key=lambda x: x.serial_number)" t-as="line">
                                    <tr>
                                        <td style="text-align: center;"><t t-esc="line.serial_number"/></td>
                                        <td>
                                            <t t-if="line.line_type == 'downpayment'">Down Payment</t>
                                            <t t-if="line.line_type == 'dld_fee'">DLD Fee</t>
                                            <t t-if="line.line_type == 'admin_fee'">Admin Fee</t>
                                            <t t-if="line.line_type == 'emi'">Installment <t t-esc="line.serial_number - 3"/></t>
                                        </td>
                                        <td><t t-esc="line.collection_date.strftime('%d %B %Y')"/></td>
                                        <td><t t-esc="o.currency_id.symbol"/><t t-esc="'{:,.2f}'.format(line.capital_repayment)"/></td>
                                        <td>
                                            <span t-if="line.collection_status == 'unpaid'" class="installment-unpaid">Unpaid</span>
                                            <span t-if="line.collection_status == 'paid'" class="installment-paid">Paid</span>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                            <tfoot>
                                <tr style="background-color: #34495e; color: white; font-weight: bold;">
                                    <td colspan="3" style="text-align: right; padding: 15px;">TOTAL:</td>
                                    <td colspan="2"><t t-esc="o.currency_id.symbol"/><t t-esc="'{:,.2f}'.format(sum(o.property_sale_line_ids.mapped('capital_repayment')))"/></td>
                                </tr>
                            </tfoot>
                        </table>

                        <!-- Broker Information (if applicable) -->
                        <t t-if="o.seller_id">
                            <div class="section-header">Broker Information</div>
                            <div class="info-row">
                                <span class="info-label">Broker/Seller:</span>
                                <span class="info-value" t-field="o.seller_id.name"/>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Broker Commission:</span>
                                <span class="info-value">
                                    <t t-esc="'{:.1f}'.format(o.broker_commission_percentage)"/>%
                                    (<t t-esc="o.currency_id.symbol"/><t t-esc="'{:,.2f}'.format(o.broker_commission_total_amount)"/>)
                                </span>
                            </div>
                        </t>

                        <!-- Payment Progress (if confirmed) -->
                        <t t-if="o.state in ['confirmed', 'invoiced']">
                            <div class="section-header">Payment Progress</div>
                            <div class="summary-box">
                                <div class="summary-item">
                                    <span>Payment Progress:</span>
                                    <span><t t-esc="'{:.1f}'.format(o.payment_progress)"/>%</span>
                                </div>
                                <div class="summary-item">
                                    <span>Total Paid:</span>
                                    <span>
                                        <t t-esc="o.currency_id.symbol"/>
                                        <t t-esc="'{:,.2f}'.format(sum(o.property_sale_line_ids.filtered(lambda l: l.collection_status == 'paid').mapped('capital_repayment')))"/>
                                    </span>
                                </div>
                                <div class="summary-item">
                                    <span>Outstanding Balance:</span>
                                    <span>
                                        <t t-esc="o.currency_id.symbol"/>
                                        <t t-esc="'{:,.2f}'.format(sum(o.property_sale_line_ids.filtered(lambda l: l.collection_status == 'unpaid').mapped('capital_repayment')))"/>
                                    </span>
                                </div>
                            </div>
                        </t>

                        <!-- Footer Notes -->
                        <div class="footer-note">
                            <strong>Important Notes:</strong><br/>
                            • This sales offer is valid for 30 days from the date of issue.<br/>
                            • All payments must be made according to the payment schedule outlined above.<br/>
                            • Late payment charges may apply for overdue installments.<br/>
                            • The property will be transferred upon completion of all payments.<br/>
                            • Terms and conditions apply. Please contact us for more details.
                        </div>

                        <div style="margin-top: 50px; text-align: center; color: #7f8c8d; font-size: 12px;">
                            <p>Generated on <t t-esc="datetime.datetime.now().strftime('%d %B %Y at %H:%M')"/></p>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>

    <!-- Report Action -->
    <record id="action_report_sales_offer" model="ir.actions.report">
        <field name="name">Sales Offer Report</field>
        <field name="model">property.sale</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">property_management.sales_offer_report_template</field>
        <field name="report_file">property_management.sales_offer_report_template</field>
        <field name="binding_model_id" ref="model_property_sale"/>
        <field name="binding_type">report</field>
        <field name="print_report_name">'Sales_Offer_%s_%s' % (object.name, object.partner_id.name)</field>
    </record>
</odoo>
