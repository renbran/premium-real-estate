<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Sale Order Form View - Commission Management Enhancement -->
        <record id="view_order_form_commission" model="ir.ui.view">
            <field name="name">sale.order.form.commission</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">
                <!-- Add commission smart buttons to button box -->
                <xpath expr="//form/sheet/div[@name='button_box']" position="inside">
                    <button name="action_view_commission_lines" type="object" class="oe_stat_button" icon="fa-list" invisible="commission_lines_count == 0">
                        <div class="o_stat_info">
                            <field name="commission_lines_count" widget="statinfo" string="Commission Lines"/>
                        </div>
                    </button>

                    <button name="action_view_commission_dashboard" type="object" class="oe_stat_button" icon="fa-dashboard" invisible="commission_lines_count == 0">
                        <span class="o_stat_text">Commission</span>
                        <span class="o_stat_text">Dashboard</span>
                    </button>
                </xpath>

                <!-- Add total commission amount in Commission Management tab instead -->
                <!-- Removed from amount_total location as it's not reliably found in all Odoo 17 views -->

                <!-- Add Commission Management Tab -->
                <xpath expr="//form/sheet/notebook" position="inside">
                    <page string="Commission Management" name="commission_management">
                        <!-- Information Banner -->
                        <div class="alert alert-info" role="alert">
                            <strong>Commission Calculation Types Available for ALL Partners:</strong>
                            <br/>
                            <ul>
                                <li>
                                    <strong>Unit Price / Sales Value:</strong> Commission calculated based on the product's unit price</li>
                                <li>
                                    <strong>Order Total (Without Tax):</strong> Commission calculated based on the order's untaxed total amount</li>
                                <li>
                                    <strong>Fixed Amount:</strong> Set a fixed commission amount regardless of order value</li>
                            </ul>
                            All three calculation types can be used for any partner type (Broker, Agent, Manager, etc.). Simply select the type that applies to each partner.
                        </div>

                        <!-- Commission Status and Actions -->
                        <group name="commission_header">
                            <group string="Commission Status">
                                <field name="commission_status"/>
                                <field name="commission_processed"/>
                                <field name="is_fully_invoiced"/>
                                <field name="has_posted_invoices"/>
                                <field name="purchase_order_count" invisible="1"/>
                            </group>
                            <group string="Commission Actions">
                                <button name="action_process_commissions" string="Process Commissions" type="object" class="btn-primary" invisible="commission_processed"/>
                                <button name="action_force_process_commissions" string="Force Process" type="object" class="btn-warning" invisible="commission_processed"/>
                                <button name="action_reset_commissions" string="Reset to Draft" type="object" class="btn-secondary" invisible="commission_status == 'draft'"/>
                            </group>
                        </group>

                        <!-- Commission Totals and Pricing -->
                        <group string="Commission Summary">
                            <group>
                                <field name="sales_value" widget="monetary" string="Unit Price (Sales Value)"/>
                                <field name="total_commission_amount" widget="monetary"/>
                                <field name="total_external_commission_amount" widget="monetary"/>
                                <field name="total_internal_commission_amount" widget="monetary"/>
                            </group>
                            <group>
                                <field name="company_share" widget="monetary"/>
                                <field name="net_company_share" widget="monetary"/>
                            </group>
                        </group>

                        <!-- Commission Partner Configuration -->
                        <notebook>
                            <!-- External Commission Tab -->
                            <page string="External Commission" name="external_commission">
                                <group>
                                    <group string="Broker">
                                        <field name="broker_partner_id"/>
                                        <field name="broker_commission_type"/>
                                        <field name="broker_calculation_base" invisible="broker_commission_type == 'fixed'" widget="radio" help="Select calculation basis: Unit Price, Order Total (Untaxed), or Order Total (With Tax)"/>
                                        <field name="broker_rate" invisible="broker_commission_type == 'fixed'"/>
                                        <field name="broker_amount" widget="monetary"/>
                                    </group>
                                    <group string="Referrer">
                                        <field name="referrer_partner_id"/>
                                        <field name="referrer_commission_type"/>
                                        <field name="referrer_calculation_base" invisible="referrer_commission_type == 'fixed'" widget="radio" help="Select calculation basis: Unit Price, Order Total (Untaxed), or Order Total (With Tax)"/>
                                        <field name="referrer_rate" invisible="referrer_commission_type == 'fixed'"/>
                                        <field name="referrer_amount" widget="monetary"/>
                                    </group>
                                </group>
                                <group>
                                    <group string="Cashback">
                                        <field name="cashback_partner_id"/>
                                        <field name="cashback_commission_type"/>
                                        <field name="cashback_calculation_base" invisible="cashback_commission_type == 'fixed'" widget="radio" help="Select calculation basis: Unit Price, Order Total (Untaxed), or Order Total (With Tax)"/>
                                        <field name="cashback_rate" invisible="cashback_commission_type == 'fixed'"/>
                                        <field name="cashback_amount" widget="monetary"/>
                                    </group>
                                    <group string="Other External">
                                        <field name="other_external_partner_id"/>
                                        <field name="other_external_commission_type"/>
                                        <field name="other_external_calculation_base" invisible="other_external_commission_type == 'fixed'" widget="radio" help="Select calculation basis: Unit Price, Order Total (Untaxed), or Order Total (With Tax)"/>
                                        <field name="other_external_rate" invisible="other_external_commission_type == 'fixed'"/>
                                        <field name="other_external_amount" widget="monetary"/>
                                    </group>
                                </group>
                            </page>

                            <!-- Internal Commission Tab -->
                            <page string="Internal Commission" name="internal_commission">
                                <group>
                                    <group string="Agent 1">
                                        <field name="agent1_partner_id"/>
                                        <field name="agent1_commission_type"/>
                                        <field name="agent1_calculation_base" invisible="agent1_commission_type == 'fixed'" widget="radio" help="Select calculation basis: Unit Price, Order Total (Untaxed), or Order Total (With Tax)"/>
                                        <field name="agent1_rate" invisible="agent1_commission_type == 'fixed'"/>
                                        <field name="agent1_amount" widget="monetary"/>
                                    </group>
                                    <group string="Agent 2">
                                        <field name="agent2_partner_id"/>
                                        <field name="agent2_commission_type"/>
                                        <field name="agent2_calculation_base" invisible="agent2_commission_type == 'fixed'" widget="radio" help="Select calculation basis: Unit Price, Order Total (Untaxed), or Order Total (With Tax)"/>
                                        <field name="agent2_rate" invisible="agent2_commission_type == 'fixed'"/>
                                        <field name="agent2_amount" widget="monetary"/>
                                    </group>
                                </group>
                                <group>
                                    <group string="Manager">
                                        <field name="manager_partner_id"/>
                                        <field name="manager_commission_type"/>
                                        <field name="manager_calculation_base" invisible="manager_commission_type == 'fixed'" widget="radio" help="Select calculation basis: Unit Price, Order Total (Untaxed), or Order Total (With Tax)"/>
                                        <field name="manager_rate" invisible="manager_commission_type == 'fixed'"/>
                                        <field name="manager_amount" widget="monetary"/>
                                    </group>
                                    <group string="Director">
                                        <field name="director_partner_id"/>
                                        <field name="director_commission_type"/>
                                        <field name="director_calculation_base" invisible="director_commission_type == 'fixed'" widget="radio" help="Select calculation basis: Unit Price, Order Total (Untaxed), or Order Total (With Tax)"/>
                                        <field name="director_rate" invisible="director_commission_type == 'fixed'"/>
                                        <field name="director_amount" widget="monetary"/>
                                    </group>
                                </group>
                            </page>

                            <!-- Legacy Commission Tab -->
                            <page string="Legacy Commission" name="legacy_commission">
                                <group>
                                    <group string="Consultant">
                                        <field name="consultant_id"/>
                                        <field name="consultant_commission_type"/>
                                        <field name="consultant_comm_percentage" invisible="consultant_commission_type == 'fixed'"/>
                                        <field name="salesperson_commission" widget="monetary"/>
                                    </group>
                                    <group string="Manager">
                                        <field name="manager_id"/>
                                        <field name="manager_legacy_commission_type"/>
                                        <field name="manager_comm_percentage" invisible="manager_legacy_commission_type == 'fixed'"/>
                                        <field name="manager_commission" widget="monetary"/>
                                    </group>
                                </group>
                                <group>
                                    <group string="Second Agent">
                                        <field name="second_agent_id"/>
                                        <field name="second_agent_commission_type"/>
                                        <field name="second_agent_comm_percentage" invisible="second_agent_commission_type == 'fixed'"/>
                                        <field name="second_agent_commission" widget="monetary"/>
                                    </group>
                                    <group string="Director">
                                        <field name="director_id"/>
                                        <field name="director_legacy_commission_type"/>
                                        <field name="director_comm_percentage" invisible="director_legacy_commission_type == 'fixed'"/>
                                        <field name="director_commission" widget="monetary"/>
                                    </group>
                                </group>
                            </page>

                            <!-- Commission Lines Tab -->
                            <page string="Commission Lines" name="commission_lines">
                                <field name="commission_line_ids" nolabel="1">
                                    <list>
                                        <field name="partner_id"/>
                                        <field name="commission_type_id"/>
                                        <field name="role"/>
                                        <field name="commission_category"/>
                                        <field name="calculation_method"/>
                                        <field name="calculation_base"/>
                                        <field name="rate"/>
                                        <field name="commission_amount" widget="monetary"/>
                                        <field name="state"/>
                                    </list>
                                    <form>
                                        <header>
                                            <button name="action_calculate" type="object" string="Calculate" class="btn-primary" invisible="state != 'draft'"/>
                                            <button name="action_confirm" type="object" string="Confirm" class="btn-primary" invisible="state not in ['draft', 'calculated']"/>
                                            <button name="action_process" type="object" string="Process" class="btn-primary" invisible="state not in ['draft', 'calculated', 'confirmed']"/>
                                            <field name="state" widget="statusbar" statusbar_visible="draft,calculated,confirmed,processed,paid"/>
                                        </header>
                                        <sheet>
                                            <group>
                                                <group>
                                                    <field name="partner_id"/>
                                                    <field name="commission_type_id"/>
                                                    <field name="role"/>
                                                </group>
                                                <group>
                                                    <field name="commission_category"/>
                                                    <field name="calculation_method"/>
                                                    <field name="calculation_base" widget="radio" help="Unit Price, Order Total (Untaxed), or Order Total (With Tax)"/>
                                                    <field name="rate"/>
                                                </group>
                                            </group>
                                            <field name="commission_amount" widget="monetary"/>
                                        </sheet>
                                    </form>
                                </field>
                            </page>

                            <!-- Purchase Orders Tab -->
                            <page string="Commission Purchase Orders" name="commission_pos" invisible="purchase_order_count == 0">
                                <field name="purchase_order_ids" nolabel="1">
                                    <list>
                                        <field name="name"/>
                                        <field name="partner_id"/>
                                        <field name="date_order"/>
                                        <field name="state"/>
                                    </list>
                                </field>
                            </page>
                        </notebook>
                    </page>
                </xpath>
            </field>
        </record>

        <!-- Sale Order Tree View Enhancement -->
        <record id="view_quotation_tree_commission" model="ir.ui.view">
            <field name="name">sale.order.tree.commission</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_quotation_tree"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='state']" position="after">
                    <field name="commission_status" optional="show"/>
                    <field name="total_commission_amount" optional="hide" widget="monetary"/>
                </xpath>
            </field>
        </record>

        <!-- Sale Order Search View Enhancement -->
        <record id="view_sales_order_filter_commission" model="ir.ui.view">
            <field name="name">sale.order.search.commission</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_sales_order_filter"/>
            <field name="arch" type="xml">
                <xpath expr="//filter[@name='my_sale_orders_filter']" position="after">
                    <separator/>
                    <filter string="Commission Processed" name="commission_processed" domain="[('commission_processed', '=', True)]"/>
                    <filter string="Commission Pending" name="commission_pending" domain="[('commission_processed', '=', False)]"/>
                </xpath>
                <xpath expr="//group" position="inside">
                    <filter string="Commission Status" name="group_commission_status" context="{'group_by': 'commission_status'}"/>
                </xpath>
            </field>
        </record>
    </data>
</odoo>
